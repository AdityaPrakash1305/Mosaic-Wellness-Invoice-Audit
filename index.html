<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Invoice Guardian ‚Äî AI Invoice Auditor</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
:root{
  --bg:#060e1d;--s1:#0d1a2e;--s2:#132237;--s3:#1a2d46;
  --bd:rgba(100,160,255,.09);--bd2:rgba(0,212,170,.3);
  --acc:#00d4aa;--adim:rgba(0,212,170,.1);--agl:0 0 22px rgba(0,212,170,.28);
  --red:#ff4757;--rdim:rgba(255,71,87,.1);
  --yel:#c49b00;--blu:#6c8fff;
  --txt:#d6e8ff;--tm:#5b7da8;--sh:0 4px 28px rgba(0,0,0,.5);
  --f:'Outfit',sans-serif;--m:'JetBrains Mono',monospace;--r:14px;
}
[data-theme=light]{
  --bg:#dde8f5;--s1:#eaf1fb;--s2:#d4e3f5;--s3:#c5d8f0;
  --bd:rgba(30,80,160,.12);--bd2:rgba(0,140,120,.35);
  --acc:#007a5e;--adim:rgba(0,122,94,.1);--agl:0 0 20px rgba(0,122,94,.2);
  --red:#b91c1c;--rdim:rgba(185,28,28,.1);
  --yel:#78350f;--blu:#1e40af;
  --txt:#0f2647;--tm:#3a5a84;--sh:0 4px 24px rgba(10,40,100,.12);
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{min-height:100%;background:var(--bg);color:var(--txt);font-family:var(--f);-webkit-font-smoothing:antialiased;}
::selection{background:rgba(0,212,170,.18);}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--s3);border-radius:4px;}
input,button{font-family:var(--f);outline:none;}
a{color:var(--acc);text-decoration:none;}
@keyframes fu{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
@keyframes fi{from{opacity:0}to{opacity:1}}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.25}}
@keyframes tIn{from{opacity:0;transform:translateX(-50%) translateY(10px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}
@keyframes tOut{to{opacity:0;transform:translateX(-50%) translateY(8px)}}
.fu{animation:fu .4s ease both}.fu1{animation:fu .4s .07s ease both}.fu2{animation:fu .4s .14s ease both}
.fu3{animation:fu .4s .21s ease both}.fu4{animation:fu .4s .28s ease both}.fi{animation:fi .3s ease}
.pulse{animation:pulse 1.4s ease-in-out infinite}
.hdr{background:var(--s1);border-bottom:1px solid var(--bd);padding:0 32px;position:sticky;top:0;z-index:200;}
.hdr-in{max-width:1280px;margin:0 auto;height:60px;display:flex;align-items:center;justify-content:space-between;gap:12px;}
.logo{display:flex;align-items:center;gap:10px;cursor:pointer;}
.logo-ico{width:36px;height:36px;border-radius:9px;background:linear-gradient(135deg,#00d4aa,#0090ff);display:flex;align-items:center;justify-content:center;font-size:18px;}
.logo-name{font-size:17px;font-weight:800;letter-spacing:-.02em;}
.hdr-r{display:flex;align-items:center;gap:8px;flex-wrap:wrap;}
.btn{display:inline-flex;align-items:center;gap:7px;padding:9px 18px;border-radius:9px;border:none;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap;}
.btn-acc{background:var(--acc);color:#041510;}.btn-acc:hover{filter:brightness(1.08);transform:translateY(-1px);}
.btn-ghost{background:var(--s2);color:var(--tm);border:1px solid var(--bd);}.btn-ghost:hover{color:var(--txt);}
.btn-lg{padding:13px 28px;font-size:15px;border-radius:12px;}
.btn-sm{padding:7px 14px;font-size:12px;border-radius:8px;}
.ico-btn{background:var(--s2);border:1px solid var(--bd);border-radius:8px;padding:7px 10px;cursor:pointer;font-size:15px;color:var(--txt);transition:all .2s;}
.cr-btn{display:flex;align-items:center;gap:8px;background:var(--s2);border:1px solid var(--bd);border-radius:9px;padding:7px 14px;cursor:pointer;font-size:13px;font-weight:500;color:var(--tm);transition:all .2s;}
.av{width:26px;height:26px;border-radius:50%;background:linear-gradient(135deg,#00d4aa,#0090ff);display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:800;color:#041510;}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.72);backdrop-filter:blur(6px);z-index:500;display:flex;align-items:center;justify-content:center;padding:20px;}
.modal{background:var(--s1);border:1px solid var(--bd);border-radius:20px;padding:32px;max-width:500px;width:100%;max-height:90vh;overflow-y:auto;animation:fu .28s ease;}
.modal-xl{max-width:840px;}
.mtabs{display:flex;gap:2px;background:var(--s2);border:1px solid var(--bd);border-radius:9px;padding:3px;margin-bottom:22px;}
.mtab{flex:1;background:transparent;border:none;border-radius:7px;padding:8px 4px;font-size:12px;font-weight:600;cursor:pointer;color:var(--tm);font-family:var(--f);transition:all .2s;text-align:center;}
.mtab.act{background:var(--s3);color:var(--txt);}
.cl{display:flex;align-items:center;gap:12px;background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:14px 16px;margin-bottom:10px;color:var(--txt);transition:border-color .2s;}
.cl:hover{border-color:var(--bd2);}
.cl-l{font-size:10px;color:var(--tm);text-transform:uppercase;letter-spacing:.07em;font-weight:700;margin-bottom:3px;}
.cl-v{font-size:13px;font-weight:600;color:var(--acc);}
.hero{max-width:1280px;margin:0 auto;padding:60px 32px;display:grid;grid-template-columns:1fr 1fr;gap:56px;align-items:start;}
.badge-pill{display:inline-flex;align-items:center;gap:7px;background:var(--adim);border:1px solid var(--bd2);border-radius:20px;padding:6px 14px;font-size:11px;font-weight:700;color:var(--acc);letter-spacing:.07em;text-transform:uppercase;margin-bottom:22px;}
.h1{font-size:52px;font-weight:900;line-height:1.06;letter-spacing:-.03em;margin-bottom:18px;}
.h1 em{color:var(--acc);font-style:normal;}
.hp{font-size:17px;color:var(--tm);line-height:1.7;margin-bottom:32px;}
.feat-grid{display:grid;grid-template-columns:1fr 1fr;gap:9px;margin-bottom:32px;}
.feat{background:var(--s1);border:1px solid var(--bd);border-radius:12px;padding:15px;display:flex;gap:11px;align-items:flex-start;transition:border-color .2s;}
.feat:hover{border-color:var(--bd2);}
.feat-ico{width:36px;height:36px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.feat-n{font-size:13px;font-weight:700;margin-bottom:3px;}.feat-d{font-size:12px;color:var(--tm);line-height:1.5;}
.stats-row{display:flex;gap:28px;}
.stat-n{font-size:26px;font-weight:900;font-family:var(--m);}
.stat-l{font-size:12px;color:var(--tm);margin-top:2px;}
.up-panel{background:var(--s1);border:1px solid var(--bd);border-radius:16px;padding:24px;}
.up-zone{border:2px dashed var(--bd);border-radius:12px;padding:40px 20px;text-align:center;cursor:pointer;transition:all .22s;background:var(--s2);}
.up-zone:hover,.up-zone.drag{border-color:var(--acc);background:var(--adim);}
.up-zone.rdy{border-color:var(--acc);border-style:solid;background:var(--adim);}
.demo-lbl{font-size:10px;color:var(--tm);text-transform:uppercase;letter-spacing:.08em;font-weight:700;margin-bottom:11px;margin-top:20px;}
.demo-card{background:var(--s2);border:1px solid var(--bd);border-radius:11px;padding:14px 16px;margin-bottom:9px;transition:border-color .2s;}
.demo-card:hover{border-color:var(--bd2);}
.demo-top{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:10px;}
.demo-n{font-size:13px;font-weight:700;margin-bottom:2px;}
.demo-s{font-size:12px;color:var(--tm);}
.demo-btns{display:flex;gap:7px;flex-shrink:0;}
.info{background:rgba(0,144,255,.06);border:1px solid rgba(0,144,255,.15);border-radius:11px;padding:15px 18px;margin-top:14px;}
.info-t{font-size:13px;font-weight:700;color:#60a5fa;margin-bottom:6px;}
.info-b{font-size:13px;color:var(--tm);line-height:1.9;}
.db{max-width:1280px;margin:0 auto;padding:24px 32px;}
.db-top{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:20px;gap:12px;flex-wrap:wrap;}
.tabs{display:flex;border-bottom:1px solid var(--bd);margin-bottom:22px;overflow-x:auto;}
.tab{background:none;border:none;border-bottom:2px solid transparent;padding:10px 18px;font-size:13px;font-weight:500;color:var(--tm);cursor:pointer;font-family:var(--f);transition:all .2s;white-space:nowrap;}
.tab.act{color:var(--acc);border-bottom-color:var(--acc);font-weight:700;}
.kpi-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:22px;}
.kpi{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);padding:21px 22px;position:relative;overflow:hidden;transition:transform .2s;}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:var(--kc,var(--acc));}
.kpi:hover{transform:translateY(-2px);}
.kpi-lbl{font-size:10px;color:var(--tm);font-weight:700;text-transform:uppercase;letter-spacing:.08em;margin-bottom:10px;}
.kpi-v{font-size:24px;font-weight:800;font-family:var(--m);line-height:1;color:var(--kc,var(--txt));}
.kpi-f{font-size:11px;color:var(--tm);margin-top:7px;}
.card{background:var(--s1);border:1px solid var(--bd);border-radius:var(--r);overflow:hidden;}
.card-hd{padding:18px 22px;border-bottom:1px solid var(--bd);display:flex;align-items:center;justify-content:space-between;gap:12px;}
.card-t{font-size:14px;font-weight:700;}
.card-s{font-size:12px;color:var(--tm);margin-top:2px;}
.tw{overflow-x:auto;}
table{width:100%;border-collapse:collapse;}
thead tr{background:var(--s2);}
th{padding:9px 14px;text-align:left;font-size:10px;font-weight:700;color:var(--tm);text-transform:uppercase;letter-spacing:.07em;white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--bd);transition:background .15s;cursor:pointer;}
tbody tr:hover{background:var(--s2);}
tbody tr:last-child{border-bottom:none;}
td{padding:12px 14px;font-size:13px;}
.b{display:inline-flex;align-items:center;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:700;white-space:nowrap;}
.bg{background:rgba(0,212,170,.12);color:#00c49a;}
.br{background:rgba(255,71,87,.12);color:#ff4757;}
.by{background:rgba(255,211,42,.12);color:#c49b00;}
.bb{background:rgba(108,143,255,.12);color:#6c8fff;}
.bgr{background:rgba(100,116,139,.12);color:#94a3b8;}
[data-theme=light] .bg{color:#006e54;}[data-theme=light] .br{color:#b91c1c;}
[data-theme=light] .by{color:#78350f;}[data-theme=light] .bb{color:#1e40af;}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
.g3{display:grid;grid-template-columns:3fr 2fr;gap:18px;}
.bar-row{margin-bottom:14px;}
.bar-head{display:flex;justify-content:space-between;margin-bottom:5px;font-size:12px;}
.bar-track{background:var(--s3);border-radius:4px;height:7px;overflow:hidden;margin-bottom:3px;}
.bar-fill{height:100%;border-radius:4px;transition:width 1.1s cubic-bezier(.16,1,.3,1);}
.sc{background:var(--s2);border:1px solid var(--bd);border-radius:9px;padding:12px 14px;}
.sc-l{font-size:10px;color:var(--tm);text-transform:uppercase;letter-spacing:.07em;font-weight:700;margin-bottom:5px;}
.sc-v{font-size:15px;font-weight:700;font-family:var(--m);}
.fc{border-radius:10px;padding:16px;margin-bottom:12px;background:var(--s2);border:1px solid var(--bd);border-left:3px solid var(--fc,#94a3b8);}
.fc-row{display:flex;justify-content:space-between;align-items:flex-start;gap:12px;margin-bottom:8px;}
.fc-body{font-size:13px;color:var(--tm);line-height:1.65;}
.fc-sol{background:var(--adim);border:1px solid var(--bd2);border-radius:8px;padding:10px 13px;margin-top:10px;font-size:13px;color:var(--acc);}
.find-banner{background:var(--rdim);border:1px solid rgba(255,71,87,.2);border-radius:11px;padding:16px 20px;margin-bottom:18px;display:flex;gap:14px;align-items:center;}
.step-item{display:flex;align-items:center;gap:11px;padding:9px 14px;border-radius:9px;margin-bottom:4px;transition:background .2s;}
.step-item.cur{background:var(--adim);border:1px solid var(--bd2);}
.toast{position:fixed;bottom:22px;left:50%;transform:translateX(-50%);background:var(--s3);border:1px solid var(--bd);border-radius:10px;padding:11px 20px;font-size:13px;font-weight:600;display:flex;align-items:center;gap:8px;z-index:9999;box-shadow:var(--sh);animation:tIn .3s ease;white-space:nowrap;}
.toast.out{animation:tOut .3s ease forwards;}
@media(max-width:800px){
  .hero{grid-template-columns:1fr;gap:28px;padding:32px 16px;}
  .h1{font-size:34px;}.kpi-grid{grid-template-columns:1fr 1fr;}
  .g2,.g3{grid-template-columns:1fr;}.hdr{padding:0 16px;}
  .db{padding:16px;}.feat-grid{grid-template-columns:1fr;}
}
</style>
</head>
<body>
<div id="root"></div>
<script>
// Initialize PDF.js worker
if (window.pdfjsLib) {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// FREE GROQ API KEY
// 1. Go to console.groq.com
// 2. Sign up free ‚Äî no credit card needed
// 3. Click "Create API Key" ‚Üí copy it (starts with gsk_)
// 4. Replace YOUR_GROQ_KEY_HERE below
// Free tier: 14,400 requests / day, forever free
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
window.GROQ_API_KEY = "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";

// PDF text extraction ‚Äî runs in browser, no cost
window.extractPDFText = async function(base64) {
  if (!window.pdfjsLib) return "[PDF.js not loaded ‚Äî text extraction unavailable]";
  try {
    const bin = atob(base64);
    const arr = new Uint8Array(bin.length);
    for (let i = 0; i < bin.length; i++) arr[i] = bin.charCodeAt(i);
    const pdf = await pdfjsLib.getDocument({ data: arr }).promise;
    let text = "";
    for (let p = 1; p <= Math.min(pdf.numPages, 10); p++) {
      const page = await pdf.getPage(p);
      const tc = await page.getTextContent();
      text += "\n--- Page " + p + " ---\n" + tc.items.map(function(i){ return i.str; }).join(" ");
    }
    return text.trim() || "[No text found in PDF ‚Äî may be a scanned image]";
  } catch(e) {
    return "[PDF read error: " + e.message + "]";
  }
};

// Call Groq API with extracted text
window.callGroq = async function(apiKey, textContent, contractText) {
  var SYSTEM = `You are Invoice Guardian ‚Äî the world's most accurate contract-vs-invoice auditor for the Indian market.

You receive up to TWO documents:
1. A CONTRACT (may or may not be provided) ‚Äî defines agreed rates, GST%, payment terms, scope
2. An INVOICE ‚Äî what the vendor is actually billing

YOUR JOB:
- If ONLY an invoice is provided: audit it for math errors, GST compliance, unknown surcharges
- If BOTH contract AND invoice are provided: compare every line item on the invoice against the contract terms. Flag every deviation ‚Äî overcharge, wrong GST%, service not in scope, wrong quantity, wrong unit, missing discount, etc.

INDUSTRIES COVERED: All ‚Äî logistics, IT/software, petroleum, pharma, marketing, manufacturing, retail, construction, healthcare, finance, legal, FMCG, chemicals, real estate, telecom. Never reject an invoice just because it's not logistics.

EXTRACTION ‚Äî read exactly as written:
- Contract: extract agreed rates per item/service, GST%, payment terms, scope of work, validity period, any penalty clauses
- Invoice: extract vendor, GSTIN, invoice number, dates, every line item (description, HSN/SAC, qty, unit, rate, taxable amount, GST%, GST amount), subtotals, grand total

AUDIT CHECKS:
1. Math: qty √ó rate = amount (flag calculation_error if wrong by even ‚Çπ1)
2. GST math: amount √ó (gst%/100) = gst_amount (flag calculation_error if wrong)
3. Totals: sum of lines = subtotal, subtotal + gst = grand_total
4. Contract rate vs billed rate: if invoice rate > contract rate ‚Üí flag overcharge with exact ‚Çπ difference
5. Contract GST% vs billed GST%: if different ‚Üí flag gst_mismatch
6. Service not in contract: if a line item is not in the contract scope ‚Üí flag unknown_surcharge
7. Unknown charges: HSN/SAC missing, "miscellaneous" without explanation ‚Üí flag unknown_surcharge
8. GST law compliance: valid slabs 0/5/12/18/28%. Petroleum (HSN 2709-2711) mostly exempt.

CONFIDENCE: 95-99 for digital text, 85-94 for scanned/image docs.

Return ONLY a JSON object. Start with { end with }. No markdown. No explanation.

{
  "vendor_name": "string",
  "invoice_number": "string",
  "invoice_date": "string",
  "due_date": "string",
  "gstin": "string",
  "vendor_address": "string",
  "client": "string",
  "client_gstin": "string",
  "contract_reference": "string or null ‚Äî contract number/date if found",
  "contract_validity": "string or null",
  "line_items": [{"description":"","hsn_code":"","quantity":0,"unit":"","unit_rate":0,"amount":0,"gst_rate":0,"gst_amount":0,"is_flagged":false,"contracted_rate":0,"contracted_gst":0}],
  "subtotal": 0,
  "total_gst": 0,
  "grand_total": 0,
  "contract_provided": true,
  "flags": [{"type":"overcharge|gst_mismatch|calculation_error|unknown_surcharge|duplicate_risk|out_of_scope","description":"exact explanation with numbers from both documents","item":"exact line item name","billed_amount":0,"correct_amount":0,"overcharge_amount":0,"severity":"high|medium|low","contract_clause":"relevant contract clause or null"}],
  "audit_summary": {"total_billed":0,"total_correct":0,"total_overcharge":0,"overcharge_percentage":0,"contract_compliant":true,"recommendation":"specific actionable instruction","confidence_score":95}
}`;

  var models = [
    "llama-3.3-70b-versatile",
    "llama-3.1-70b-versatile",
    "llama3-70b-8192",
    "mixtral-8x7b-32768"
  ];

  var lastErr = "";
  for (var i = 0; i < models.length; i++) {
    var model = models[i];
    try {
      var resp = await fetch("https://api.groq.com/openai/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "Bearer " + apiKey
        },
        body: JSON.stringify({
          model: model,
          messages: [
            { role: "system", content: SYSTEM },
            { role: "user", content: contractText
                ? "CONTRACT TERMS:\n" + contractText + "\n\n---\n\nINVOICE TO AUDIT AGAINST CONTRACT:\n" + textContent + "\n\nCompare every invoice line against the contract. Return ONLY JSON."
                : "Audit this invoice. Return ONLY JSON:\n\n" + textContent }
          ],
          temperature: 0.05,
          max_tokens: 4096
        })
      });

      var data = await resp.json();

      if (data.error) {
        var msg = data.error.message || JSON.stringify(data.error);
        if (resp.status === 401 || msg.includes("invalid_api_key") || msg.includes("Invalid API Key")) {
          throw new Error("BAD_KEY");
        }
        if (msg.includes("decommissioned") || msg.includes("not found") || msg.includes("does not exist")) {
          lastErr = msg; continue;
        }
        if (resp.status === 429 || msg.includes("rate_limit")) {
          await new Promise(function(r){ setTimeout(r, 5000); });
          lastErr = msg; continue;
        }
        lastErr = msg; continue;
      }

      var raw = (data.choices && data.choices[0] && data.choices[0].message && data.choices[0].message.content) || "";
      if (!raw) { lastErr = "empty response"; continue; }

      // Strip markdown fences
      raw = raw.replace(/^```json\s*/i, "").replace(/^```\s*/i, "").replace(/\s*```$/i, "").trim();
      // Find the JSON object
      var s = raw.indexOf("{");
      var e = raw.lastIndexOf("}");
      if (s === -1 || e === -1) { lastErr = "no JSON in response"; continue; }
      return JSON.parse(raw.slice(s, e + 1));

    } catch(err) {
      if (err.message === "BAD_KEY") throw err;
      if (err instanceof SyntaxError) { lastErr = "JSON parse error"; continue; }
      lastErr = err.message;
    }
  }
  throw new Error("ALL_MODELS_FAILED: " + lastErr);
};
</script>
<script type="text/babel">
const {useState, useRef, useEffect, useCallback} = React;

/* ‚îÄ‚îÄ CONSTANTS ‚îÄ‚îÄ */
const TL = {
  overcharge: "Rate Overcharge",
  gst_mismatch: "GST Mismatch",
  calculation_error: "Calc Error",
  unknown_surcharge: "Unknown Surcharge",
  duplicate_risk: "Duplicate Invoice"
};
const SEV_CLASS = {high:"br", medium:"by", low:"bb"};
const SEV_COLOR = {high:"#ff4757", medium:"#c49b00", low:"#6c8fff"};
const TYPE_CLASS = {overcharge:"br", gst_mismatch:"by", calculation_error:"bb", unknown_surcharge:"bgr", duplicate_risk:"by"};
const TYPE_COLOR = {overcharge:"#ff4757", gst_mismatch:"#c49b00", calculation_error:"#6c8fff", unknown_surcharge:"#00d4aa"};
const STEPS = ["Parsing document","Extracting line items","Identifying vendor & dates","Cross-checking rates","Detecting anomalies","Generating audit report"];

const inr = n => n == null ? "‚Äî" : "‚Çπ" + new Intl.NumberFormat("en-IN",{maximumFractionDigits:0}).format(n);
const inrD = n => n == null ? "‚Äî" : "‚Çπ" + new Intl.NumberFormat("en-IN",{minimumFractionDigits:2,maximumFractionDigits:2}).format(n);

/* ‚îÄ‚îÄ DEMO INVOICE TEXT (what Claude actually reads and analyses) ‚îÄ‚îÄ */
const DEMO_FTL = {
  id:"ftl", vendor:"FastTrack Logistics Ltd", invoice:"FTL-2024-0892", date:"15 Dec 2024",
  hint:"Contains rate overcharges, wrong GST rate, and an unapproved surcharge",
  gstin:"27AABCF1234A1Z5", address:"42, Transport Nagar, Andheri East, Mumbai 400069",
  client:"Mosaic Wellness Pvt Ltd", client_gstin:"27AACCM5678B2Z3", due:"14 Jan 2025",
  line_items:[
    {description:"Air Freight",hsn_code:"9965",quantity:580,unit:"kg",unit_rate:52,amount:30160,gst_rate:18,gst_amount:5428.8},
    {description:"Ground Transport",hsn_code:"9966",quantity:2400,unit:"km",unit_rate:14,amount:33600,gst_rate:12,gst_amount:4032},
    {description:"Warehousing",hsn_code:"9967",quantity:800,unit:"sqft",unit_rate:9.5,amount:7600,gst_rate:18,gst_amount:1368},
    {description:"Loading / Unloading",hsn_code:"9967",quantity:4,unit:"trips",unit_rate:2800,amount:11200,gst_rate:18,gst_amount:2016},
    {description:"Cold Storage",hsn_code:"9967",quantity:60,unit:"units",unit_rate:120,amount:7200,gst_rate:28,gst_amount:2016},
    {description:"Documentation Fees",hsn_code:"9983",quantity:1,unit:"set",unit_rate:500,amount:500,gst_rate:18,gst_amount:90},
    {description:"Fuel Surcharge",hsn_code:"N/A",quantity:1,unit:"lump",unit_rate:4800,amount:4800,gst_rate:18,gst_amount:864},
  ],
  subtotal:95060, total_gst:15814.8, grand_total:110874.8,
  text:`GST TAX INVOICE
Vendor: FastTrack Logistics Ltd | GSTIN: 27AABCF1234A1Z5
Address: 42, Transport Nagar, Andheri East, Mumbai ‚Äì 400069
Invoice No: FTL-2024-0892 | Date: 15 December 2024 | Due: 14 January 2025
Billed To: Mosaic Wellness Pvt Ltd | GSTIN: 27AACCM5678B2Z3

LINE ITEMS:
Description            | HSN  | Qty  | Unit  | Rate   | Amount    | GST% | GST Amt
Air Freight            | 9965 | 580  | kg    | 52.00  | 30160.00  | 18%  | 5428.80
Ground Transport       | 9966 | 2400 | km    | 14.00  | 33600.00  | 12%  | 4032.00
Warehousing            | 9967 | 800  | sqft  | 9.50   | 7600.00   | 18%  | 1368.00
Loading / Unloading    | 9967 | 4    | trips | 2800   | 11200.00  | 18%  | 2016.00
Cold Storage           | 9967 | 60   | units | 120    | 7200.00   | 28%  | 2016.00
Documentation Fees     | 9983 | 1    | set   | 500    | 500.00    | 18%  | 90.00
Fuel Surcharge         | N/A  | 1    | lump  | 4800   | 4800.00   | 18%  | 864.00

Subtotal: Rs. 95,060.00 | CGST: Rs. 7,907.40 | SGST: Rs. 7,907.40 | Grand Total: Rs. 1,10,874.80

CONTRACT RATES (what was agreed):
Air Freight: Rs.45/kg at 18% GST | Ground Transport: Rs.12/km at 12% GST
Warehousing: Rs.8/sqft at 18% GST | Loading/Unloading: Rs.2500/trip at 18% GST
Cold Storage: Rs.120/unit at 18% GST (NOT 28%) | No Fuel Surcharge in contract`
};

const DEMO_BSC = {
  id:"bsc", vendor:"BlueStar Cargo Solutions", invoice:"BSC-2024-1205", date:"22 Dec 2024",
  hint:"Contains wrong GST on insurance, arithmetic error, and unapproved surcharge",
  gstin:"29AABCB5678C1Z2", address:"18, Industrial Area, Phase 2, Pune 411018",
  client:"Mosaic Wellness Pvt Ltd", client_gstin:"27AACCM5678B2Z3", due:"21 Jan 2025",
  line_items:[
    {description:"LTL Road Freight",hsn_code:"9966",quantity:1200,unit:"km",unit_rate:12,amount:14400,gst_rate:12,gst_amount:1728},
    {description:"Cargo Insurance",hsn_code:"9971",quantity:1,unit:"policy",unit_rate:3200,amount:3200,gst_rate:28,gst_amount:896},
    {description:"Packaging & Handling",hsn_code:"9967",quantity:150,unit:"units",unit_rate:42,amount:6300,gst_rate:18,gst_amount:1314},
    {description:"Express Delivery Surcharge",hsn_code:"N/A",quantity:1,unit:"lump",unit_rate:2500,amount:2500,gst_rate:18,gst_amount:450},
    {description:"Return Logistics",hsn_code:"9966",quantity:3,unit:"trips",unit_rate:1800,amount:5400,gst_rate:12,gst_amount:648},
    {description:"Documentation & Compliance",hsn_code:"9983",quantity:1,unit:"set",unit_rate:750,amount:750,gst_rate:18,gst_amount:135},
  ],
  subtotal:32550, total_gst:5171, grand_total:37541,
  text:`GST TAX INVOICE
Vendor: BlueStar Cargo Solutions | GSTIN: 29AABCB5678C1Z2
Address: 18, Industrial Area, Phase 2, Pune ‚Äì 411018
Invoice No: BSC-2024-1205 | Date: 22 December 2024 | Due: 21 January 2025
Billed To: Mosaic Wellness Pvt Ltd | GSTIN: 27AACCM5678B2Z3

LINE ITEMS:
Description                 | HSN  | Qty  | Unit   | Rate   | Amount    | GST% | GST Amt
LTL Road Freight            | 9966 | 1200 | km     | 12.00  | 14400.00  | 12%  | 1728.00
Cargo Insurance             | 9971 | 1    | policy | 3200   | 3200.00   | 28%  | 896.00
Packaging & Handling        | 9967 | 150  | units  | 42.00  | 6300.00   | 18%  | 1314.00
Express Delivery Surcharge  | N/A  | 1    | lump   | 2500   | 2500.00   | 18%  | 450.00
Return Logistics            | 9966 | 3    | trips  | 1800   | 5400.00   | 12%  | 648.00
Documentation & Compliance  | 9983 | 1    | set    | 750    | 750.00    | 18%  | 135.00

NOTE: Packaging & Handling total shown as Rs.7,614 in vendor system (arithmetic error: 6300+1314=7614 is correct, but taxable 6300 * 1.18 = 7434, not 7614)
Subtotal: Rs. 32,550.00 | CGST: Rs. 2,585.50 | SGST: Rs. 2,585.50 | Grand Total: Rs. 37,541.00

NOTES: Cargo Insurance (HSN 9971) correct GST is 18% not 28%. Express Delivery Surcharge not in contract.`
};

/* ‚îÄ‚îÄ DEMO DOCUMENTS: IT SERVICES CONTRACT + INVOICE ‚îÄ‚îÄ */
const DEMO_IT_CONTRACT = {
  id:"it-contract",
  label:"TechServe Solutions ‚Äî Service Agreement",
  ref:"TSS/MST/2024/047",
  filename:"TechServe_Contract_2024.pdf",
  text:`SERVICE AGREEMENT ‚Äî CONTRACT NOTE
Contract Ref: TSS/MST/2024/047
Date: 01 November 2024 | Valid Until: 31 October 2025

BETWEEN:
Service Provider: TechServe Solutions Pvt Ltd
GSTIN: 27AABCT5432D1Z6
Address: 14th Floor, One BKC, Bandra Kurla Complex, Mumbai ‚Äì 400051

AND:
Client: Mosaic Wellness Pvt Ltd
GSTIN: 27AACCM5678B2Z3
Address: 301, Business Hub, Goregaon West, Mumbai ‚Äì 400104

AGREED SCOPE & RATES:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Service Description          | SAC   | Rate         | GST%
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Software Development         | 9983  | Rs.85/hour   | 18%
UI/UX Design Services        | 9983  | Rs.70/hour   | 18%
Project Management           | 9983  | Rs.65/hour   | 18%
Cloud Hosting (AWS/GCP)      | 9983  | Rs.12,000/mo | 18%
QA & Testing                 | 9983  | Rs.55/hour   | 18%
Annual Maintenance Contract  | 9987  | Rs.45,000/yr | 18%
Data Migration (one-time)    | 9983  | Rs.30,000    | 18%
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

PAYMENT TERMS:
- Payment due: 30 days from invoice date
- Late payment: 1.5% per month
- Disputes: within 7 days of invoice receipt

GENERAL CONDITIONS:
- All rates are exclusive of GST
- GST applicable at 18% on all services (SAC 9983 / 9987)
- Any service NOT listed above requires written pre-approval
- Travel & out-of-pocket expenses billed at actuals with receipts
- No surcharges or additional fees unless explicitly agreed in writing
- Invoices must reference this contract number: TSS/MST/2024/047

Signed by:
TechServe Solutions Pvt Ltd          Mosaic Wellness Pvt Ltd
Authorised Signatory                  Authorised Signatory
`};

const DEMO_IT_INVOICE = {
  id:"it-invoice",
  vendor:"TechServe Solutions Pvt Ltd",
  invoice:"TSS-INV-2024-0312",
  date:"30 Nov 2024",
  hint:"Invoice has rate overcharges, a GST error, and a service not in contract",
  gstin:"27AABCT5432D1Z6",
  address:"14th Floor, One BKC, Bandra Kurla Complex, Mumbai ‚Äì 400051",
  client:"Mosaic Wellness Pvt Ltd",
  client_gstin:"27AACCM5678B2Z3",
  due:"30 Dec 2024",
  line_items:[
    {description:"Software Development",hsn_code:"9983",quantity:120,unit:"hours",unit_rate:95,amount:11400,gst_rate:18,gst_amount:2052},
    {description:"UI/UX Design Services",hsn_code:"9983",quantity:40,unit:"hours",unit_rate:70,amount:2800,gst_rate:18,gst_amount:504},
    {description:"Project Management",hsn_code:"9983",quantity:30,unit:"hours",unit_rate:80,amount:2400,gst_rate:18,gst_amount:432},
    {description:"Cloud Hosting (AWS/GCP)",hsn_code:"9983",quantity:1,unit:"month",unit_rate:12000,amount:12000,gst_rate:28,gst_amount:3360},
    {description:"QA & Testing",hsn_code:"9983",quantity:25,unit:"hours",unit_rate:55,amount:1375,gst_rate:18,gst_amount:247.5},
    {description:"Express Delivery Coordination",hsn_code:"N/A",quantity:1,unit:"lump",unit_rate:5000,amount:5000,gst_rate:18,gst_amount:900},
  ],
  subtotal:34975, total_gst:7495.5, grand_total:42470.5,
  contractRef:"TSS/MST/2024/047",
  text:`GST TAX INVOICE
Vendor: TechServe Solutions Pvt Ltd | GSTIN: 27AABCT5432D1Z6
Address: 14th Floor, One BKC, Bandra Kurla Complex, Mumbai ‚Äì 400051
Invoice No: TSS-INV-2024-0312 | Date: 30 November 2024 | Due: 30 December 2024
Contract Ref: TSS/MST/2024/047
Billed To: Mosaic Wellness Pvt Ltd | GSTIN: 27AACCM5678B2Z3

LINE ITEMS:
Description                    | SAC  | Qty | Unit  | Rate   | Amount    | GST% | GST Amt
Software Development           | 9983 | 120 | hrs   | 95.00  | 11400.00  | 18%  | 2052.00
UI/UX Design Services          | 9983 | 40  | hrs   | 70.00  | 2800.00   | 18%  | 504.00
Project Management             | 9983 | 30  | hrs   | 80.00  | 2400.00   | 18%  | 432.00
Cloud Hosting (AWS/GCP)        | 9983 | 1   | month | 12000  | 12000.00  | 28%  | 3360.00
QA & Testing                   | 9983 | 25  | hrs   | 55.00  | 1375.00   | 18%  | 247.50
Express Delivery Coordination  | N/A  | 1   | lump  | 5000   | 5000.00   | 18%  | 900.00

Subtotal: Rs. 34,975.00 | CGST: Rs. 3,747.75 | SGST: Rs. 3,747.75 | Grand Total: Rs. 42,470.50
`};

/* ‚îÄ‚îÄ CONTRACT PDF DOWNLOAD ‚îÄ‚îÄ */
function downloadContractPDF(c) {
  const rows = [
    ["Software Development","9983","Rs.85/hour","18%"],
    ["UI/UX Design Services","9983","Rs.70/hour","18%"],
    ["Project Management","9983","Rs.65/hour","18%"],
    ["Cloud Hosting (AWS/GCP)","9983","Rs.12,000/month","18%"],
    ["QA & Testing","9983","Rs.55/hour","18%"],
    ["Annual Maintenance Contract","9987","Rs.45,000/year","18%"],
    ["Data Migration (one-time)","9983","Rs.30,000 fixed","18%"],
  ].map(([svc,sac,rate,gst]) =>
    `<tr><td>${svc}</td><td style="font-family:monospace;font-size:11px">${sac}</td><td style="text-align:right">${rate}</td><td style="text-align:center">${gst}</td></tr>`
  ).join("");
  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Service Agreement ${c.ref}</title>
<style>body{font-family:Arial,sans-serif;padding:32px;color:#0f2647;background:#e8f0fa}
.wrap{max-width:860px;margin:0 auto;background:white;border-radius:12px;overflow:hidden;box-shadow:0 4px 24px rgba(10,40,100,.15)}
.hdr{background:linear-gradient(135deg,#1a3f7a,#0f2647);color:white;padding:28px 32px}
.co{font-size:22px;font-weight:800;color:#00d4aa;margin-bottom:4px}
.det{font-size:12px;color:rgba(255,255,255,.65);line-height:1.8}
.ref{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:12px 16px;margin-top:12px}
.ref-l{font-size:10px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.07em;margin-bottom:4px}
.ref-v{font-size:16px;font-weight:800;color:#00d4aa}
.body{padding:28px 32px}
.parties{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
.party{background:#eaf2fd;border:1px solid #c5d8f0;border-radius:8px;padding:14px 16px}
.pl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#007a5e;margin-bottom:6px}
.pn{font-size:14px;font-weight:700;margin-bottom:3px}.pd{font-size:12px;color:#3a5a84;line-height:1.6}
.sec{font-size:13px;font-weight:800;text-transform:uppercase;letter-spacing:.07em;color:#0f2647;margin:20px 0 10px;padding-bottom:6px;border-bottom:2px solid #c5d8f0}
table{width:100%;border-collapse:collapse;margin-bottom:18px}
th{background:#0f2647;color:white;padding:9px 11px;text-align:left;font-size:11px;text-transform:uppercase}
td{padding:9px 11px;border-bottom:1px solid #dce9f5;font-size:13px}
tr:nth-child(even){background:#f4f8fd}
.terms-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px}
.term-box{background:#f4f8fd;border:1px solid #c5d8f0;border-radius:8px;padding:12px}
.term-l{font-size:10px;font-weight:700;color:#3a5a84;text-transform:uppercase;letter-spacing:.06em;margin-bottom:4px}
.term-v{font-size:13px;font-weight:600;color:#0f2647}
.notice{background:#f0fdf4;border:1px solid #86efac;border-radius:7px;padding:10px 14px;font-size:12px;color:#166534;margin-bottom:16px}
.sigs{display:grid;grid-template-columns:1fr 1fr;gap:32px;padding:20px 32px;background:#eaf2fd;border-top:1px solid #c5d8f0}
.sig{text-align:center}.sl{height:1px;background:#c5d8f0;margin:36px 0 8px}.sn{font-size:11px;color:#3a5a84}.sc{font-size:13px;font-weight:700}
@media print{body{background:white;padding:0}.wrap{box-shadow:none;border-radius:0}}
</style></head><body><div class="wrap">
<div class="hdr">
  <div class="co">TechServe Solutions Pvt Ltd</div>
  <div class="det">GSTIN: 27AABCT5432D1Z6 &nbsp;|&nbsp; 14th Floor, One BKC, Bandra Kurla Complex, Mumbai ‚Äì 400051</div>
  <div class="ref"><div class="ref-l">Service Agreement / Contract Note</div><div class="ref-v">${c.ref}</div></div>
</div>
<div class="body">
<div class="notice">&#9989; <b>Invoice Guardian Demo Contract:</b> Upload this contract AND the matching invoice to see AI compare them and detect every deviation automatically.</div>
<div class="parties">
  <div class="party"><div class="pl">Service Provider</div><div class="pn">TechServe Solutions Pvt Ltd</div><div class="pd">GSTIN: 27AABCT5432D1Z6<br>14th Floor, One BKC, Mumbai ‚Äì 400051</div></div>
  <div class="party"><div class="pl">Client</div><div class="pn">Mosaic Wellness Pvt Ltd</div><div class="pd">GSTIN: 27AACCM5678B2Z3<br>301, Business Hub, Goregaon West, Mumbai ‚Äì 400104</div></div>
</div>
<div class="terms-grid">
  <div class="term-box"><div class="term-l">Contract Date</div><div class="term-v">01 November 2024</div></div>
  <div class="term-box"><div class="term-l">Valid Until</div><div class="term-v">31 October 2025</div></div>
  <div class="term-box"><div class="term-l">Payment Terms</div><div class="term-v">30 days from invoice</div></div>
  <div class="term-box"><div class="term-l">Late Payment</div><div class="term-v">1.5% per month</div></div>
</div>
<div class="sec">Agreed Services & Rates</div>
<table><thead><tr><th>Service Description</th><th>SAC Code</th><th style="text-align:right">Agreed Rate</th><th style="text-align:center">GST %</th></tr></thead>
<tbody>${rows}</tbody></table>
<div class="sec">General Conditions</div>
<div style="font-size:13px;color:#0f2647;line-height:1.9;margin-bottom:20px">
1. All rates are exclusive of GST (GST charged additionally at 18%).<br>
2. Any service NOT listed above requires written pre-approval from client.<br>
3. No surcharges or additional fees unless explicitly agreed in writing.<br>
4. Travel & out-of-pocket expenses billed at actuals with receipts only.<br>
5. Invoices must reference contract number: <strong>${c.ref}</strong><br>
6. Disputes on invoices must be raised within 7 days of receipt.<br>
7. Subject to Mumbai jurisdiction. Governed by Indian Contract Act, 1872.
</div>
</div>
<div class="sigs">
  <div class="sig"><div class="sl"></div><div class="sn">Authorised Signatory</div><div class="sc">TechServe Solutions Pvt Ltd</div></div>
  <div class="sig"><div class="sl"></div><div class="sn">Authorised Signatory</div><div class="sc">Mosaic Wellness Pvt Ltd</div></div>
</div>
</div>
</body></html>`;
  const blob = new Blob([html], {type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a"); a.href=url; a.target="_blank";
  document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setTimeout(()=>URL.revokeObjectURL(url),15000);
}

/* ‚îÄ‚îÄ PDF DOWNLOAD ‚îÄ‚îÄ */
function downloadDemoPDF(demo) {
  const rows = demo.line_items.map(li =>
    `<tr><td>${li.description}</td><td style="font-family:monospace;font-size:11px">${li.hsn_code}</td>
    <td style="text-align:center">${li.quantity} ${li.unit}</td>
    <td style="text-align:right">&#8377;${li.unit_rate.toLocaleString("en-IN")}</td>
    <td style="text-align:right">&#8377;${li.amount.toLocaleString("en-IN")}</td>
    <td style="text-align:center">${li.gst_rate}%</td>
    <td style="text-align:right">&#8377;${li.gst_amount.toLocaleString("en-IN",{maximumFractionDigits:2})}</td>
    <td style="text-align:right;font-weight:600">&#8377;${(li.amount+li.gst_amount).toLocaleString("en-IN",{maximumFractionDigits:2})}</td></tr>`
  ).join("");

  const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${demo.invoice}</title>
<style>body{font-family:Arial,sans-serif;padding:32px;color:#0f2647;background:#e8f0fa}
.wrap{max-width:900px;margin:0 auto;background:white;border-radius:12px;overflow:hidden;box-shadow:0 4px 24px rgba(10,40,100,.15)}
.hdr{background:linear-gradient(135deg,#0f2647,#1a3f7a);color:white;padding:24px 32px;display:flex;justify-content:space-between;align-items:flex-start}
.co{font-size:20px;font-weight:800;color:#00d4aa;margin-bottom:4px}.det{font-size:12px;color:rgba(255,255,255,.6);line-height:1.7}
.inv-box{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);border-radius:8px;padding:12px 16px;text-align:right}
.inum{font-size:18px;font-weight:800;margin:4px 0}.id{font-size:12px;color:rgba(255,255,255,.6)}
.body{padding:24px 32px}
.parties{display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px}
.party{background:#eaf2fd;border:1px solid #c5d8f0;border-radius:8px;padding:12px 14px}
.pl{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:#007a5e;margin-bottom:6px}
.pn{font-size:14px;font-weight:700;margin-bottom:3px}.pd{font-size:12px;color:#3a5a84;line-height:1.6}
.notice{background:#fffbeb;border:1px solid #fcd34d;border-radius:6px;padding:10px 14px;font-size:12px;color:#92400e;margin-bottom:16px}
table{width:100%;border-collapse:collapse;margin-bottom:18px}
th{background:#0f2647;color:white;padding:9px 11px;text-align:left;font-size:11px;text-transform:uppercase}
td{padding:8px 11px;border-bottom:1px solid #dce9f5;font-size:13px}
tr:nth-child(even){background:#f4f8fd}
.tw{display:flex;justify-content:flex-end;margin-bottom:20px}
.tbl{width:280px}.tr2{display:flex;justify-content:space-between;padding:6px 0;font-size:13px;border-bottom:1px solid #dce9f5}
.tg{border-top:2px solid #0f2647;border-bottom:none;margin-top:6px;padding-top:10px;font-size:16px;font-weight:800}
.ftr{padding:16px 32px;background:#eaf2fd;border-top:1px solid #c5d8f0;display:flex;justify-content:space-between;align-items:flex-end}
.terms{font-size:11px;color:#3a5a84;line-height:1.8}
.sl{width:140px;height:1px;background:#c5d8f0;margin:36px auto 7px}.sn{font-size:12px;color:#3a5a84;text-align:center}.sc{font-size:13px;font-weight:700;text-align:center}
@media print{body{background:white;padding:0}.wrap{box-shadow:none;border-radius:0}.notice{display:none}}
</style></head><body><div class="wrap">
<div class="hdr">
  <div><div class="co">${demo.vendor}</div><div class="det">GSTIN: ${demo.gstin}<br>${demo.address}</div></div>
  <div class="inv-box"><div style="font-size:10px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.07em">GST Tax Invoice</div>
  <div class="inum">${demo.invoice}</div><div class="id">Date: ${demo.date}</div><div class="id">Due: ${demo.due}</div></div>
</div>
<div class="body">
<div class="parties">
  <div class="party"><div class="pl">Billed From</div><div class="pn">${demo.vendor}</div><div class="pd">GSTIN: ${demo.gstin}<br>${demo.address}</div></div>
  <div class="party"><div class="pl">Billed To</div><div class="pn">${demo.client}</div><div class="pd">GSTIN: ${demo.client_gstin}<br>301, Business Hub, Goregaon West, Mumbai 400104</div></div>
</div>
<div class="notice">&#9888; <b>Invoice Guardian Demo:</b> Contains intentional billing errors for demonstration. Upload this PDF to Invoice Guardian to see AI detect every discrepancy.</div>
<table><thead><tr><th>Description</th><th>HSN/SAC</th><th style="text-align:center">Qty/Unit</th><th style="text-align:right">Rate(&#8377;)</th><th style="text-align:right">Taxable</th><th style="text-align:center">GST%</th><th style="text-align:right">GST Amt</th><th style="text-align:right">Total(&#8377;)</th></tr></thead>
<tbody>${rows}</tbody></table>
<div class="tw"><div class="tbl">
  <div class="tr2"><span>Subtotal</span><span>&#8377;${demo.subtotal.toLocaleString("en-IN",{minimumFractionDigits:2})}</span></div>
  <div class="tr2"><span>CGST</span><span>&#8377;${(demo.total_gst/2).toLocaleString("en-IN",{minimumFractionDigits:2})}</span></div>
  <div class="tr2"><span>SGST</span><span>&#8377;${(demo.total_gst/2).toLocaleString("en-IN",{minimumFractionDigits:2})}</span></div>
  <div class="tr2 tg"><span>Grand Total</span><span>&#8377;${demo.grand_total.toLocaleString("en-IN",{minimumFractionDigits:2})}</span></div>
</div></div>
</div>
<div class="ftr">
  <div class="terms">1. Payment due within 30 days.<br>2. Disputes within 7 days.<br>3. Subject to Mumbai jurisdiction.<br><em>Computer-generated invoice.</em></div>
  <div><div class="sl"></div><div class="sn">Authorised Signatory</div><div class="sc">${demo.vendor}</div></div>
</div></div>

</body></html>`;
  const blob = new Blob([html], {type:"text/html;charset=utf-8"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url; a.target = "_blank";
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  setTimeout(() => URL.revokeObjectURL(url), 15000);
}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
function Toast({msg, onDone}) {
  const [out, setOut] = useState(false);
  useEffect(() => {
    const a = setTimeout(() => setOut(true), 2800);
    const b = setTimeout(onDone, 3200);
    return () => { clearTimeout(a); clearTimeout(b); };
  }, []);
  return <div className={`toast${out?" out":""}`}><span style={{color:"var(--acc)"}}>‚úì</span>{msg}</div>;
}

/* ‚îÄ‚îÄ CREATOR MODAL ‚îÄ‚îÄ */
function CreatorModal({onClose}) {
  const [t, setT] = useState("website");
  return (
    <div className="overlay" onClick={onClose}>
      <div className="modal" onClick={e => e.stopPropagation()}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
          <div style={{fontSize:19,fontWeight:800}}>Created by Aditya Prakash</div>
          <button className="btn btn-ghost btn-sm" onClick={onClose}>‚úï</button>
        </div>
        <div className="mtabs">
          {[["website","üåê Website"],["founder","üë§ Founder"],["contact","üì¨ Contact"]].map(([k,l]) =>
            <button key={k} className={`mtab${t===k?" act":""}`} onClick={() => setT(k)}>{l}</button>
          )}
        </div>
        {t==="website" && <div style={{fontSize:14,color:"var(--tm)",lineHeight:1.85}}>
          <div style={{fontSize:22,fontWeight:800,color:"var(--acc)",marginBottom:14}}>Invoice Guardian</div>
          <p><strong style={{color:"var(--txt)"}}>Invoice Guardian</strong> is an AI Invoice Auditor to detect overcharges, anomalies, GST errors and calculation mistakes.</p>
          <br/><p>Estimated to save <strong style={{color:"var(--txt)"}}>5‚Äì10% of total billable amount</strong> by catching errors before payments are released. Powered by <strong style={{color:"var(--txt)"}}>Groq AI</strong> (LLaMA 3.3 70B) for fast, accurate extraction.</p>
        </div>}
        {t==="founder" && <div style={{fontSize:14,color:"var(--tm)",lineHeight:1.85}}>
          <div style={{width:52,height:52,borderRadius:"50%",background:"linear-gradient(135deg,#00d4aa,#0090ff)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,fontWeight:800,color:"#041510",marginBottom:14}}>A</div>
          <div style={{fontSize:20,fontWeight:800,color:"var(--txt)",marginBottom:10}}>Hey! I'm Aditya Prakash.</div>
          <p>3rd Year Student at <strong style={{color:"var(--txt)"}}>RA Podar College of Commerce and Economics</strong>. Passionate about Finance and enthusiastic about the opportunities the new era would present to us!</p>
          <br/><p>Join with me if you want to contribute meaningfully!</p>
        </div>}
        {t==="contact" && <div>
          <div style={{fontSize:15,fontWeight:700,marginBottom:16}}>Let's connect üëã</div>
          <a className="cl" href="https://www.linkedin.com/in/adityaprakash8105" target="_blank">
            <span style={{fontSize:22}}>üíº</span>
            <div><div className="cl-l">LinkedIn</div><div className="cl-v">linkedin.com/in/adityaprakash8105</div></div>
          </a>
          <a className="cl" href="mailto:aditya.x.prakash@gmail.com">
            <span style={{fontSize:22}}>üìß</span>
            <div><div className="cl-l">Email</div><div className="cl-v">aditya.x.prakash@gmail.com</div></div>
          </a>
        </div>}
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ INVOICE DETAIL MODAL ‚îÄ‚îÄ */
function InvDetail({inv, onClose}) {
  const oc = inv.audit_summary?.total_overcharge || 0;
  return (
    <div className="overlay" onClick={onClose}>
      <div className="modal modal-xl" onClick={e => e.stopPropagation()}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:16,gap:12,flexWrap:"wrap"}}>
          <div>
            <div style={{fontSize:18,fontWeight:800}}>{inv.vendor_name}</div>
            <div style={{fontSize:12,color:"var(--tm)",fontFamily:"var(--m)",marginTop:3}}>{inv.invoice_number} ¬∑ {inv.invoice_date}</div>
          </div>
          <div style={{display:"flex",gap:8,flexWrap:"wrap",alignItems:"center"}}>
            <span className="b bb">Confidence: {inv.audit_summary?.confidence_score||95}%</span>
            <span className={`b ${(inv.flags?.length||0)>0?"br":"bg"}`}>{inv.flags?.length||0} flags</span>
            <button className="btn btn-ghost btn-sm" onClick={onClose}>‚úï Close</button>
          </div>
        </div>
        <div style={{background:oc>0?"var(--rdim)":"var(--adim)",border:`1px solid ${oc>0?"rgba(255,71,87,.2)":"rgba(0,212,170,.2)"}`,borderRadius:10,padding:"14px 18px",marginBottom:18,display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"}}>
          <span style={{fontSize:28}}>{oc>0?"‚ö†Ô∏è":"‚úÖ"}</span>
          <div style={{flex:1}}>
            <div style={{fontWeight:800,fontSize:15}}>{oc>0?`${inr(oc)} overcharge detected (${(inv.audit_summary?.overcharge_percentage||0).toFixed(1)}%)`:"Invoice is clean ‚Äî no issues found"}</div>
            <div style={{fontSize:13,color:"var(--tm)",marginTop:3,lineHeight:1.5}}>{inv.audit_summary?.recommendation}</div>
          </div>
        </div>
        <div className="g2" style={{gap:10,marginBottom:16}}>
          {[
            {l:"Invoice Date",v:inv.invoice_date},{l:"Due Date",v:inv.due_date||"‚Äî"},
            {l:"Subtotal",v:inrD(inv.subtotal),m:true},{l:"Total GST",v:inrD(inv.total_gst),m:true},
            {l:"Grand Total Billed",v:inrD(inv.grand_total),m:true,c:"var(--red)"},{l:"Correct Amount",v:inrD(inv.audit_summary?.total_correct),m:true,c:"var(--acc)"},
          ].map(item =>
            <div key={item.l} className="sc">
              <div className="sc-l">{item.l}</div>
              <div className="sc-v" style={{color:item.c||"var(--txt)",fontFamily:item.m?"var(--m)":"var(--f)",fontSize:item.c?18:15}}>{item.v}</div>
            </div>
          )}
        </div>
        {(inv.flags?.length||0)>0 && <div style={{marginBottom:16}}>
          <div style={{fontSize:13,fontWeight:700,marginBottom:10}}>Issues Found ‚Äî {inv.flags.length}</div>
          {inv.flags.map((f,i) =>
            <div key={i} className="fc" style={{"--fc":SEV_COLOR[f.severity]||"#94a3b8"}}>
              <div className="fc-row">
                <span className={`b ${SEV_CLASS[f.severity]||"bgr"}`}>{TL[f.type]||f.type}</span>
                <span className={`b ${SEV_CLASS[f.severity]||"bgr"}`}>{f.severity?.toUpperCase()}</span>
              </div>
              <div className="fc-body">{f.description}</div>
              {f.overcharge_amount>0 && <div style={{fontSize:15,fontWeight:700,fontFamily:"var(--m)",color:"var(--red)",marginTop:6}}>Overcharge: {inr(f.overcharge_amount)}</div>}
              <div className="fc-sol">üí° Correct: {inr(f.correct_amount)}. Request revised invoice.</div>
            </div>
          )}
        </div>}
        <div style={{fontSize:13,fontWeight:700,marginBottom:10}}>All Line Items</div>
        <div className="tw">
          <table>
            <thead><tr><th>Description</th><th>HSN</th><th>Qty</th><th>Rate</th><th>Amount</th><th>GST%</th><th>GST Amt</th><th>Status</th></tr></thead>
            <tbody>
              {(inv.line_items||[]).map((li,i) =>
                <tr key={i} style={{background:li.is_flagged?"rgba(255,71,87,0.04)":""}}>
                  <td style={{fontWeight:li.is_flagged?700:400}}>{li.description}</td>
                  <td style={{fontFamily:"var(--m)",fontSize:11,color:"var(--tm)"}}>{li.hsn_code||"‚Äî"}</td>
                  <td style={{fontFamily:"var(--m)"}}>{li.quantity} {li.unit}</td>
                  <td style={{fontFamily:"var(--m)"}}>{inr(li.unit_rate)}</td>
                  <td style={{fontFamily:"var(--m)",fontWeight:600}}>{inr(li.amount)}</td>
                  <td style={{fontFamily:"var(--m)"}}>{li.gst_rate}%</td>
                  <td style={{fontFamily:"var(--m)"}}>{inrD(li.gst_amount)}</td>
                  <td>{li.is_flagged?<span className="b br">‚ö† Flagged</span>:<span className="b bg">‚úì OK</span>}</td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ CANVAS BAR CHART ‚îÄ‚îÄ */
function BarChart({invoices}) {
  const ref = useRef(null);
  useEffect(() => {
    const c = ref.current; if(!c) return;
    const dpr = window.devicePixelRatio||1;
    const W = (c.parentElement?.offsetWidth||500), H = 200;
    c.style.width = W+"px"; c.style.height = H+"px";
    c.width = W*dpr; c.height = H*dpr;
    const ctx = c.getContext("2d"); ctx.scale(dpr,dpr); ctx.clearRect(0,0,W,H);
    const dark = document.documentElement.getAttribute("data-theme") !== "light";
    const tc = dark?"#5b7da8":"#3a5a84";
    const gc = dark?"rgba(255,255,255,0.05)":"rgba(0,0,0,0.05)";
    const pL=70,pR=20,pT=20,pB=38,cW=W-pL-pR,cH=H-pT-pB;
    const maxV = Math.max(...invoices.map(i=>i.audit_summary?.total_billed||0))*1.2||200000;
    const bW = Math.min(28,cW/(invoices.length*3));
    for(let i=0;i<=4;i++){
      const y=pT+cH*(1-i/4);
      ctx.beginPath();ctx.strokeStyle=gc;ctx.lineWidth=1;ctx.moveTo(pL,y);ctx.lineTo(W-pR,y);ctx.stroke();
      const val=Math.round(maxV*i/4);
      ctx.fillStyle=tc;ctx.font="10px JetBrains Mono,monospace";ctx.textAlign="right";
      ctx.fillText(val>=100000?"‚Çπ"+(val/100000).toFixed(1)+"L":val>=1000?"‚Çπ"+(val/1000).toFixed(0)+"k":"‚Çπ"+val,pL-5,y+3);
    }
    const slot=cW/invoices.length;
    invoices.forEach((inv,i) => {
      const x=pL+slot*i+slot/2;
      const billed=inv.audit_summary?.total_billed||0,oc=inv.audit_summary?.total_overcharge||0;
      const bH=Math.max(2,(billed/maxV)*cH),bY=pT+cH-bH;
      const g1=ctx.createLinearGradient(0,bY,0,bY+bH);g1.addColorStop(0,"#6c8fff");g1.addColorStop(1,"rgba(108,143,255,.4)");
      ctx.fillStyle=g1;ctx.beginPath();ctx.roundRect(x-bW-2,bY,bW,bH,3);ctx.fill();
      if(oc>0){const oH=Math.max(2,(oc/maxV)*cH),oY=pT+cH-oH;
        const g2=ctx.createLinearGradient(0,oY,0,oY+oH);g2.addColorStop(0,"#ff4757");g2.addColorStop(1,"rgba(255,71,87,.4)");
        ctx.fillStyle=g2;ctx.beginPath();ctx.roundRect(x+2,oY,bW,oH,3);ctx.fill();}
      ctx.fillStyle=tc;ctx.font="10px Outfit,sans-serif";ctx.textAlign="center";
      ctx.fillText((inv.vendor_name||"").split(" ")[0].slice(0,10),x,pT+cH+17);
    });
    [[W-pR-120,"#6c8fff","Billed"],[W-pR-55,"#ff4757","Overcharge"]].forEach(([x,col,lbl]) => {
      ctx.fillStyle=col;ctx.fillRect(x,6,9,9);ctx.fillStyle=tc;ctx.font="11px Outfit";ctx.textAlign="left";ctx.fillText(lbl,x+13,14);
    });
  },[invoices]);
  return <div style={{width:"100%",height:200}}><canvas ref={ref}/></div>;
}

/* ‚îÄ‚îÄ DONUT CHART ‚îÄ‚îÄ */
function DonutChart({data, total}) {
  const ref = useRef(null);
  useEffect(() => {
    const c = ref.current; if(!c) return;
    const dpr = window.devicePixelRatio||1;
    c.width=160*dpr; c.height=160*dpr;
    const ctx=c.getContext("2d"); ctx.scale(dpr,dpr);
    const dark=document.documentElement.getAttribute("data-theme")!=="light";
    const cx=80,cy=80,R=72,r=46; let s=-Math.PI/2;
    if(!data||data.every(d=>!d.pct)){
      ctx.beginPath();ctx.arc(cx,cy,R,0,2*Math.PI);ctx.arc(cx,cy,r,2*Math.PI,0,true);
      ctx.closePath();ctx.fillStyle=dark?"#1a2d46":"#c5d8f0";ctx.fill();
    } else {
      data.forEach(d => {
        if(!d.pct) return;
        const a=(d.pct/100)*2*Math.PI;
        ctx.beginPath();ctx.arc(cx,cy,R,s,s+a);ctx.arc(cx,cy,r,s+a,s,true);
        ctx.closePath();ctx.fillStyle=d.color;ctx.fill(); s+=a;
      });
    }
    ctx.beginPath();ctx.arc(cx,cy,r-1,0,2*Math.PI);ctx.fillStyle=dark?"#0d1a2e":"#eaf1fb";ctx.fill();
  },[data]);
  return (
    <div style={{position:"relative",width:160,height:160}}>
      <canvas ref={ref} style={{width:160,height:160}}/>
      <div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}>
        <div style={{fontSize:20,fontWeight:800,fontFamily:"var(--m)",color:"var(--acc)"}}>{total}</div>
        <div style={{fontSize:10,color:"var(--tm)",textTransform:"uppercase",letterSpacing:".06em"}}>total</div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ ANALYSIS SCREEN ‚îÄ‚îÄ */
function AnalysisScreen({step, pct, name}) {
  const circ = 2*Math.PI*44;
  return (
    <div style={{minHeight:"60vh",display:"flex",alignItems:"center",justifyContent:"center",padding:32}}>
      <div className="card" style={{padding:"52px 40px",textAlign:"center",maxWidth:520,width:"100%"}}>
        <div style={{position:"relative",width:108,height:108,margin:"0 auto 20px"}}>
          <svg width="108" height="108" viewBox="0 0 108 108" style={{transform:"rotate(-90deg)"}}>
            <circle cx="54" cy="54" r="44" fill="none" stroke="var(--s3)" strokeWidth="8"/>
            <circle cx="54" cy="54" r="44" fill="none" stroke="var(--acc)" strokeWidth="8"
              strokeDasharray={`${circ*pct/100} ${circ}`} strokeLinecap="round"
              style={{transition:"stroke-dasharray .5s ease"}}/>
          </svg>
          <div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}>
            <div style={{fontSize:18,fontWeight:700,fontFamily:"var(--m)",color:"var(--acc)"}}>{pct}%</div>
          </div>
        </div>
        <div style={{fontSize:20,fontWeight:800,marginBottom:6}}>Analyzing Invoice</div>
        <div style={{fontSize:12,color:"var(--tm)",marginBottom:24,fontFamily:"var(--m)"}}>{name}</div>
        <div style={{maxWidth:380,margin:"0 auto"}}>
          {STEPS.map((s,i) =>
            <div key={i} className={`step-item${i===step?" cur":""}`}>
              <div className={i===step?"pulse":""} style={{width:8,height:8,borderRadius:"50%",flexShrink:0,background:i<=step?"var(--acc)":"var(--s3)"}}/>
              <div style={{fontSize:13,color:i<=step?"var(--txt)":"var(--tm)",fontWeight:i===step?600:400,flex:1,textAlign:"left"}}>{s}</div>
              {i<step && <span style={{color:"var(--acc)",fontWeight:700}}>‚úì</span>}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ DASHBOARD TAB ‚îÄ‚îÄ */
function DashTab({invoices}) {
  const tot = {
    billed: invoices.reduce((s,i)=>s+(i.audit_summary?.total_billed||0),0),
    correct: invoices.reduce((s,i)=>s+(i.audit_summary?.total_correct||0),0),
    oc: invoices.reduce((s,i)=>s+(i.audit_summary?.total_overcharge||0),0),
    issues: invoices.reduce((s,i)=>s+(i.flags?.length||0),0),
  };
  const contractInvoices = invoices.filter(i=>i.contract_provided);
  const nonCompliant = invoices.filter(i=>i.contract_provided && i.audit_summary?.contract_compliant===false).length;
  const byType = {};
  invoices.forEach(inv => (inv.flags||[]).forEach(f => { byType[f.type]=(byType[f.type]||0)+1; }));
  const typeTotal = Object.values(byType).reduce((s,v)=>s+v,0)||1;
  const donutData = Object.entries(byType).map(([k,v])=>({type:k,count:v,pct:Math.round(v/typeTotal*100),color:TYPE_COLOR[k]||"#94a3b8"}));
  const allFlagged = invoices.flatMap(inv => (inv.flags||[]).map(f=>({...f,invoiceNo:inv.invoice_number,vendor:inv.vendor_name})));
  const maxOC = Math.max(...invoices.map(i=>i.audit_summary?.total_overcharge||0),1);
  return (
    <div className="fi">
      {contractInvoices.length>0 && (
        <div style={{background:nonCompliant>0?"var(--rdim)":"var(--adim)",border:`1px solid ${nonCompliant>0?"rgba(255,71,87,.25)":"rgba(0,212,170,.25)"}`,borderRadius:11,padding:"12px 18px",marginBottom:16,display:"flex",alignItems:"center",gap:12}}>
          <span style={{fontSize:24}}>{nonCompliant>0?"‚ö†Ô∏è":"‚úÖ"}</span>
          <div>
            <div style={{fontWeight:700,fontSize:14,color:nonCompliant>0?"var(--red)":"var(--acc)"}}>
              {nonCompliant>0?`${nonCompliant} invoice${nonCompliant!==1?"s":""} NOT compliant with contract`:"All invoices are contract-compliant"}
            </div>
            <div style={{fontSize:12,color:"var(--tm)",marginTop:2}}>{contractInvoices.length} invoice{contractInvoices.length!==1?"s":""} audited against contract terms</div>
          </div>
        </div>
      )}
      <div className="kpi-grid">
        {[
          {label:"Total Billed",val:inr(tot.billed),foot:`${invoices.length} invoice${invoices.length!==1?"s":""}`,c:"var(--txt)",ic:"üí≥"},
          {label:"Correct Total",val:inr(tot.correct),foot:"After corrections",c:"#00d4aa",ic:"‚úÖ"},
          {label:"Overcharges",val:inr(tot.oc),foot:`${tot.billed>0?((tot.oc/tot.billed)*100).toFixed(1):0}% of spend`,c:"#ff4757",ic:"üö®"},
          {label:"Issues Found",val:tot.issues,foot:`Across ${invoices.length} invoice${invoices.length!==1?"s":""}`,c:"#c49b00",ic:"‚ö†Ô∏è"},
        ].map((k,i) =>
          <div key={k.label} className={`kpi fu${i+1}`} style={{"--kc":k.c}}>
            <div className="kpi-lbl">{k.ic} {k.label}</div>
            <div className="kpi-v">{k.val}</div>
            <div className="kpi-f">{k.foot}</div>
          </div>
        )}
      </div>
      <div className="g3 fu2" style={{marginBottom:18}}>
        <div className="card">
          <div className="card-hd"><div className="card-t">Billed vs Overcharge by Invoice</div></div>
          <div style={{padding:"14px 18px 10px"}}><BarChart invoices={invoices}/></div>
        </div>
        <div className="card">
          <div className="card-hd"><div className="card-t">Issues by Type</div></div>
          <div style={{padding:"16px 20px",display:"flex",flexDirection:"column",alignItems:"center",gap:14}}>
            <DonutChart data={donutData} total={typeTotal}/>
            <div style={{width:"100%"}}>
              {donutData.map(d =>
                <div key={d.type} style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:7,fontSize:12}}>
                  <div style={{display:"flex",alignItems:"center",gap:7}}>
                    <div style={{width:7,height:7,borderRadius:"50%",background:d.color,flexShrink:0}}/>
                    <span style={{color:"var(--tm)"}}>{TL[d.type]||d.type}</span>
                  </div>
                  <span style={{fontFamily:"var(--m)",fontWeight:600}}>{d.count} ({d.pct}%)</span>
                </div>
              )}
            </div>
          </div>
        </div>
      </div>
      <div className="g2 fu3" style={{marginBottom:18}}>
        <div className="card">
          <div className="card-hd"><div className="card-t">Overcharge by Vendor</div></div>
          <div style={{padding:"16px 22px"}}>
            {invoices.filter(i=>i.audit_summary?.total_overcharge>0).map(inv =>
              <div key={inv.id} className="bar-row">
                <div className="bar-head">
                  <span style={{fontWeight:600}}>{inv.vendor_name}</span>
                  <span style={{fontFamily:"var(--m)",color:"var(--red)",fontWeight:700}}>{inr(inv.audit_summary.total_overcharge)}</span>
                </div>
                <div className="bar-track"><div className="bar-fill" style={{width:Math.round(inv.audit_summary.total_overcharge/maxOC*100)+"%",background:"linear-gradient(90deg,#ff4757,rgba(255,71,87,.4))"}}/></div>
                <div style={{fontSize:11,color:"var(--tm)",marginTop:2}}>{inr(inv.audit_summary.total_billed)} billed ¬∑ {(inv.audit_summary.overcharge_percentage||0).toFixed(1)}% overcharged</div>
              </div>
            )}
            {invoices.every(i=>!(i.audit_summary?.total_overcharge>0)) && <div style={{color:"var(--acc)",padding:16,textAlign:"center",fontWeight:600}}>‚úì No overcharges</div>}
          </div>
        </div>
        <div className="card">
          <div className="card-hd"><div className="card-t">Summary Metrics</div></div>
          <div style={{padding:"16px 20px"}}>
            <div className="g2" style={{gap:10}}>
              {[
                {l:"Flagged Items",v:allFlagged.length},
                {l:"Avg Overcharge",v:inr(Math.round(tot.oc/Math.max(invoices.filter(i=>i.audit_summary?.total_overcharge>0).length,1)))},
                {l:"Highest Overcharge",v:inr(Math.max(...allFlagged.map(f=>f.overcharge_amount||0),0))},
                {l:"AI Confidence",v:Math.round(invoices.reduce((s,i)=>s+(i.audit_summary?.confidence_score||95),0)/Math.max(invoices.length,1))+"%"},
              ].map(item => <div key={item.l} className="sc"><div className="sc-l">{item.l}</div><div className="sc-v">{item.v}</div></div>)}
            </div>
          </div>
        </div>
      </div>
      <div className="card fu4">
        <div className="card-hd"><div className="card-t">Line Item Analysis ‚Äî Billed vs Expected</div><div className="card-s">{allFlagged.length} discrepancies</div></div>
        <div style={{padding:"16px 22px"}}>
          {allFlagged.length===0 && <div style={{color:"var(--tm)",textAlign:"center",padding:24}}>No flagged items.</div>}
          {allFlagged.map((f,i) => {
            const ocPct = f.billed_amount>0?Math.round(f.overcharge_amount/f.billed_amount*100):0;
            return <div key={i} className="bar-row">
              <div className="bar-head">
                <span><strong>{f.item}</strong> <span style={{color:"var(--tm)",fontSize:11}}>({f.invoiceNo})</span></span>
                <span style={{fontFamily:"var(--m)",color:"var(--red)",fontWeight:700}}>{inr(f.billed_amount)} <span style={{fontSize:11}}>‚Üë{ocPct}%</span></span>
              </div>
              <div className="bar-track"><div className="bar-fill" style={{width:"100%",background:"linear-gradient(90deg,#ff4757,rgba(255,71,87,.35))"}}/></div>
              <div className="bar-track"><div className="bar-fill" style={{width:(f.billed_amount>0?Math.round(f.correct_amount/f.billed_amount*100):0)+"%",background:"linear-gradient(90deg,#00d4aa,rgba(0,212,170,.35))"}}/></div>
              <div style={{display:"flex",gap:16,fontSize:11,color:"var(--tm)",marginTop:2}}>
                <span style={{color:"var(--red)"}}>‚ñ† Billed: {inr(f.billed_amount)}</span>
                <span style={{color:"var(--acc)"}}>‚ñ† Correct: {inr(f.correct_amount)}</span>
                <span>Diff: {inr(f.overcharge_amount)}</span>
              </div>
            </div>;
          })}
        </div>
      </div>
    </div>
  );
}

/* ‚îÄ‚îÄ INVOICES TAB ‚îÄ‚îÄ */
function InvoicesTab({invoices, onSelect}) {
  return <div className="fi"><div className="card">
    <div className="card-hd"><div><div className="card-t">All Invoices</div><div className="card-s">Click any row for full audit detail</div></div></div>
    <div className="tw"><table>
      <thead><tr><th>Vendor</th><th>Invoice #</th><th>Date</th><th>Due</th><th>Billed</th><th>Overcharge</th><th>Flags</th><th>Contract</th><th>Confidence</th><th>Status</th></tr></thead>
      <tbody>{invoices.map(inv => {
        const oc = inv.audit_summary?.total_overcharge||0;
        return <tr key={inv.id} onClick={() => onSelect(inv)}>
          <td style={{fontWeight:700}}>{inv.vendor_name}</td>
          <td style={{fontFamily:"var(--m)",fontSize:11,color:"var(--tm)"}}>{inv.invoice_number}</td>
          <td style={{color:"var(--tm)"}}>{inv.invoice_date}</td>
          <td style={{color:"var(--tm)"}}>{inv.due_date||"‚Äî"}</td>
          <td style={{fontFamily:"var(--m)",fontWeight:600}}>{inr(inv.audit_summary?.total_billed)}</td>
          <td style={{fontFamily:"var(--m)",fontWeight:700,color:oc>0?"var(--red)":"var(--acc)"}}>{oc>0?`‚ñ≤ ${inr(oc)}`:"‚úì None"}</td>
          <td><span className={`b ${(inv.flags?.length||0)>0?"br":"bg"}`}>{inv.flags?.length||0} flag{inv.flags?.length!==1?"s":""}</span></td>
          <td>{inv.contract_provided?<span className={`b ${inv.audit_summary?.contract_compliant===false?"br":"bg"}`}>{inv.audit_summary?.contract_compliant===false?"‚úó Non-Compliant":"‚úì Compliant"}</span>:<span className="bgr b">No Contract</span>}</td>
          <td><span className="b bb">{inv.audit_summary?.confidence_score||95}%</span></td>
          <td><span className={`b ${oc>0?"br":"bg"}`}>{oc>0?"Disputed":"Approved"}</span></td>
        </tr>;
      })}</tbody>
    </table></div>
  </div></div>;
}

/* ‚îÄ‚îÄ TRANSACTIONS TAB ‚îÄ‚îÄ */
function TxTab({invoices}) {
  const allTx = invoices.flatMap(inv => (inv.line_items||[]).map((li,idx) => {
    const flag = (inv.flags||[]).find(f => f.item===li.description);
    return {...li, _key:`${inv.id}-${idx}`, vendor:inv.vendor_name, invoiceNo:inv.invoice_number, flag};
  }));
  return <div className="fi"><div className="card">
    <div className="card-hd"><div><div className="card-t">All Transactions</div><div className="card-s">{allTx.length} line items</div></div></div>
    <div className="tw"><table>
      <thead><tr><th>Invoice #</th><th>Vendor</th><th>Description</th><th>HSN</th><th>Qty</th><th>Billed (incl GST)</th><th>Correct</th><th>Difference</th><th>Issue</th></tr></thead>
      <tbody>{allTx.map(tx => {
        const billed = tx.amount+tx.gst_amount;
        const diff = tx.flag?.overcharge_amount||0;
        const correct = tx.flag ? tx.flag.correct_amount : billed;
        return <tr key={tx._key} style={{background:tx.is_flagged?"rgba(255,71,87,0.03)":""}}>
          <td style={{fontFamily:"var(--m)",fontSize:11,color:"var(--tm)"}}>{tx.invoiceNo}</td>
          <td style={{fontSize:12,fontWeight:600}}>{tx.vendor}</td>
          <td style={{fontWeight:tx.is_flagged?700:400}}>{tx.description}</td>
          <td style={{fontFamily:"var(--m)",fontSize:11,color:"var(--tm)"}}>{tx.hsn_code||"‚Äî"}</td>
          <td style={{fontFamily:"var(--m)"}}>{tx.quantity} {tx.unit}</td>
          <td style={{fontFamily:"var(--m)",fontWeight:600}}>{inrD(billed)}</td>
          <td style={{fontFamily:"var(--m)",color:tx.is_flagged?"var(--acc)":"inherit"}}>{inrD(correct)}</td>
          <td style={{fontFamily:"var(--m)",fontWeight:700,color:diff>0?"var(--red)":"var(--tm)"}}>{diff>0?`‚ñ≤ ${inr(diff)}`:"‚Äî"}</td>
          <td>{tx.flag?<span className={`b ${TYPE_CLASS[tx.flag.type]||"bgr"}`}>{TL[tx.flag.type]||tx.flag.type}</span>:<span className="b bg">‚úì Clean</span>}</td>
        </tr>;
      })}</tbody>
    </table></div>
  </div></div>;
}

/* ‚îÄ‚îÄ FINDINGS TAB ‚îÄ‚îÄ */
function FindingsTab({invoices}) {
  const all = invoices.flatMap(inv => (inv.flags||[]).map(f => ({...f,vendor:inv.vendor_name,invoiceNo:inv.invoice_number})))
    .sort((a,b)=>(b.overcharge_amount||0)-(a.overcharge_amount||0));
  const total = all.reduce((s,f)=>s+(f.overcharge_amount||0),0);
  return <div className="fi">
    <div className="find-banner">
      <span style={{fontSize:28}}>üîç</span>
      <div>
        <div style={{fontWeight:700,fontSize:14}}>{all.length} finding{all.length!==1?"s":""} ¬∑ <span style={{color:"var(--acc)"}}>{inr(total)} recoverable</span></div>
        <div style={{fontSize:13,color:"var(--tm)",marginTop:2}}>Root cause, correct amount, and resolution for each issue.</div>
      </div>
    </div>
    {all.map((f,i) =>
      <div key={i} className="fc" style={{"--fc":SEV_COLOR[f.severity]||"#94a3b8",marginBottom:14}}>
        <div className="fc-row">
          <div>
            <div style={{fontSize:15,fontWeight:800,color:SEV_COLOR[f.severity]||"var(--txt)",marginBottom:4}}>#{i+1} ‚Äî {TL[f.type]||f.type}</div>
            <div style={{fontSize:11,color:"var(--tm)",fontFamily:"var(--m)"}}>{f.invoiceNo} ¬∑ {f.vendor}</div>
          </div>
          <div style={{textAlign:"right"}}>
            <div style={{fontSize:16,fontWeight:800,fontFamily:"var(--m)",color:"var(--red)"}}>{inr(f.overcharge_amount)}</div>
            <span className={`b ${SEV_CLASS[f.severity]||"bgr"}`} style={{marginTop:5,display:"inline-flex"}}>{f.severity?.toUpperCase()}</span>
          </div>
        </div>
        <div style={{marginBottom:12}}>
          <div style={{fontSize:10,color:"var(--tm)",textTransform:"uppercase",letterSpacing:".07em",fontWeight:700,marginBottom:5}}>What's Wrong</div>
          <div className="fc-body">{f.description}</div>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:12}}>
          {[{l:"Amount Billed",v:inr(f.billed_amount),c:"var(--red)"},{l:"Should Be",v:inr(f.correct_amount),c:"var(--acc)"},{l:"You Can Recover",v:inr(f.overcharge_amount),c:"var(--red)"}].map(item =>
            <div key={item.l} style={{background:"var(--s3)",borderRadius:8,padding:"10px 12px"}}>
              <div style={{fontSize:10,color:"var(--tm)",textTransform:"uppercase",letterSpacing:".07em",fontWeight:700,marginBottom:4}}>{item.l}</div>
              <div style={{fontSize:15,fontWeight:700,fontFamily:"var(--m)",color:item.c}}>{item.v}</div>
            </div>
          )}
        </div>
        <div className="fc-sol">üí° <strong>Resolution:</strong> Contact {f.vendor} re {f.invoiceNo}. Request corrected invoice{f.correct_amount>0?` with amount revised to ${inr(f.correct_amount)}`:" with this charge removed"}.</div>
      </div>
    )}
    {all.length===0 && <div style={{textAlign:"center",padding:48,color:"var(--tm)"}}>
      <div style={{fontSize:48,marginBottom:12}}>‚úÖ</div>
      <div style={{fontSize:18,fontWeight:700,color:"var(--acc)"}}>No findings ‚Äî all invoices are clean!</div>
    </div>}
  </div>;
}

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   MAIN APP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
function App() {
  const [dark, setDark] = useState(true);
  const [view, setView] = useState("landing");
  const [showCreator, setShowCreator] = useState(false);
  const [tab, setTab] = useState("dashboard");
  const [invoices, setInvoices] = useState([]);
  const [analyzing, setAnalyzing] = useState(false);
  const [aStep, setAStep] = useState(0);
  const [aPct, setAPct] = useState(0);
  const [aName, setAName] = useState("");
  const [file64, setFile64] = useState(null);
  const [fileType, setFileType] = useState(null);
  const [fileName, setFileName] = useState("");
  const [contract64, setContract64] = useState(null);
  const [contractType, setContractType] = useState(null);
  const [contractName, setContractName] = useState("");
  const [contractDrag, setContractDrag] = useState(false);
  const [drag, setDrag] = useState(false);
  const [err, setErr] = useState("");
  const [selInv, setSelInv] = useState(null);
  const [toast, setToast] = useState(null);
  const fileRef = useRef(null);

  useEffect(() => {
    document.documentElement.setAttribute("data-theme", dark?"dark":"light");
  }, [dark]);

  const showToast = msg => setToast({msg, id:Date.now()});
  const goHome = () => { setView("landing"); setErr(""); };

  const readFile = file => {
    if(!file) return;
    const rd = new FileReader();
    rd.onload = e => {
      setFile64(e.target.result.split(",")[1]);
      setFileType(file.type);
      setFileName(file.name);
      setErr("");
    };
    rd.onerror = () => setErr("Could not read file. Please try again.");
    rd.readAsDataURL(file);
  };

  const readContract = file => {
    if(!file) return;
    const rd = new FileReader();
    rd.onload = e => {
      setContract64(e.target.result.split(",")[1]);
      setContractType(file.type);
      setContractName(file.name);
      setErr("");
    };
    rd.onerror = () => setErr("Could not read contract file.");
    rd.readAsDataURL(file);
  };

  /* Core analysis ‚Äî used for demos and uploads */
  const runAnalysis = async ({textContent, fileData, fileMime, label, contractTextContent, contractData, contractMime, contractLabel}) => {
    const key = window.GROQ_API_KEY;
    if (!key || key === "YOUR_GROQ_KEY_HERE") {
      setErr("‚ö†Ô∏è API key not set.\n\nOpen index.html in Notepad, find YOUR_GROQ_KEY_HERE and replace it with your free Groq key.\n\nGet a free key at console.groq.com ‚Äî no credit card needed. Key starts with gsk_");
      return;
    }
    if (!key.startsWith('gsk_')) {
      setErr("‚ö†Ô∏è Wrong key format. Your Groq key must start with gsk_\n\nYou entered a key starting with: " + key.slice(0,8) + "...\n\nGet the correct key at console.groq.com ‚Üí Create API Key");
      return;
    }
    if (!key.startsWith("gsk_")) {
      setErr("‚ö†Ô∏è Wrong key format. Your Groq key must start with gsk_\n\nGet the correct key at console.groq.com ‚Üí Create API Key");
      return;
    }

    setAnalyzing(true);
    setErr("");
    setAStep(0); setAPct(0); setAName(label);
    setView("analyzing");

    const pcts = [10, 25, 45, 65, 85, 96];
    let step = 0;
    const iv = setInterval(() => {
      step = Math.min(step+1, STEPS.length-1);
      setAStep(step);
      setAPct(pcts[step]);
    }, 1800);

    try {
      let text = textContent || "";
      let contractText = contractTextContent || "";

      // Extract text from uploaded invoice file
      if (!text && fileData) {
        setAStep(0); setAPct(6);
        if (fileMime === "application/pdf") {
          text = await window.extractPDFText(fileData);
        } else if (fileMime && fileMime.startsWith("image/")) {
          text = `[IMAGE INVOICE - ${label}]\nThis is a scanned invoice image. Extract all text, numbers, line items, GST rates, totals, vendor info from the image and audit it.`;
        } else {
          text = `Invoice file: ${label} (${fileMime || "unknown format"})`;
        }
      }
      if (!text || text.length < 20) {
        text = `Invoice: ${label}\n[Could not extract text ‚Äî ensure the PDF has selectable text or use a clearer image]`;
      }

      // Extract text from uploaded contract file
      if (!contractText && contractData) {
        setAStep(1); setAPct(18);
        if (contractMime === "application/pdf") {
          contractText = await window.extractPDFText(contractData);
        } else if (contractMime && contractMime.startsWith("image/")) {
          contractText = `[IMAGE CONTRACT - ${contractLabel}]\nThis is a scanned contract image. Extract all agreed rates, GST%, services, and terms from this contract.`;
        } else {
          contractText = `Contract file: ${contractLabel}`;
        }
      }

      const result = await window.callGroq(key, text, contractText || null);
      result.id = "inv-" + Date.now();

      clearInterval(iv);
      setAPct(100); setAStep(STEPS.length-1);

      setTimeout(() => {
        setAnalyzing(false);
        setInvoices(prev => {
          const idx = prev.findIndex(i => i.invoice_number===result.invoice_number);
          if(idx>=0){ const n=[...prev]; n[idx]=result; return n; }
          return [...prev, result];
        });
        setTab("dashboard");
        setView("dashboard");
        const flags = result.flags?.length||0;
        const oc = result.audit_summary?.total_overcharge||0;
        showToast(flags>0?`${flags} issue${flags>1?"s":""} found ‚Äî ${inr(oc)} recoverable`:"Invoice is clean ‚úì");
        setFile64(null); setFileName(""); setFileType(null);
        setContract64(null); setContractName(""); setContractType(null);
      }, 500);

    } catch(e) {
      clearInterval(iv);
      setAnalyzing(false);
      setView("landing");
      if (e.message === "BAD_KEY") {
        setErr("‚ùå Invalid Groq API key.\n\nGet a free key at console.groq.com\nSign up ‚Üí Create API Key ‚Üí copy the key (starts with gsk_)\nPaste it in index.html replacing YOUR_GROQ_KEY_HERE");
      } else if (e.message.startsWith("ALL_MODELS_FAILED")) {
        setErr("‚ùå All AI models busy right now. Wait 30 seconds and try again.\n\n"+e.message);
      } else {
        setErr("‚ùå Analysis failed: " + e.message);
      }
    }
  };

  const runDemoWithContract = (inv, contract) => {
    runAnalysis({
      textContent: inv.text,
      label: inv.invoice,
      contractTextContent: contract.text,
      contractLabel: contract.ref,
    });
  };

  const runDemo = demo => {
    runAnalysis({textContent: demo.text, label: demo.invoice});
  };

  const contractRef = useRef(null);

  const runUpload = () => {
    if(!file64) return;
    runAnalysis({
      fileData:file64, fileMime:fileType, label:fileName,
      contractData: contract64||null,
      contractMime: contractType||null,
      contractLabel: contractName||null,
    });
  };

  const tabList = [
    {k:"dashboard", l:"üìä Dashboard"},
    {k:"invoices",  l:`üßæ Invoices (${invoices.length})`},
    {k:"transactions", l:`üí± Transactions (${invoices.reduce((s,i)=>s+(i.line_items?.length||0),0)})`},
    {k:"findings",  l:`üîç Findings (${invoices.reduce((s,i)=>s+(i.flags?.length||0),0)})`},
  ];

  return (
    <div style={{minHeight:"100vh",background:"var(--bg)"}}>
      {toast && <Toast key={toast.id} msg={toast.msg} onDone={()=>setToast(null)}/>}
      {showCreator && <CreatorModal onClose={()=>setShowCreator(false)}/>}
      {selInv && <InvDetail inv={selInv} onClose={()=>setSelInv(null)}/>}

      {/* HEADER */}
      <header className="hdr">
        <div className="hdr-in">
          <div className="logo" onClick={goHome}>
            <div className="logo-ico">üõ°Ô∏è</div>
            <div className="logo-name">Invoice Guardian</div>
          </div>
          <div className="hdr-r">
            <button className="btn btn-ghost btn-sm" onClick={goHome}>üè† Home</button>
            <button className="ico-btn" onClick={()=>setDark(!dark)}>{dark?"‚òÄÔ∏è":"üåô"}</button>
            <button className="cr-btn" onClick={()=>setShowCreator(true)}>
              <div className="av">A</div>Created by Aditya Prakash ‚ñæ
            </button>
          </div>
        </div>
      </header>

      {/* LANDING */}
      {view==="landing" && (
        <div className="hero">
          <div>
            <div className="badge-pill fu">üõ°Ô∏è AI-POWERED INVOICE AUDITING</div>
            <h1 className="h1 fu1">Catch Every<br/><em>Overcharge</em></h1>
            <p className="hp fu1">Drop any invoice and get an instant AI audit. Detect overcharges, GST errors, duplicates, and recover 5‚Äì10% of billing losses automatically.</p>
            <div className="feat-grid fu2">
              {[
                {ico:"üî¨",n:"Smart Extraction",d:"Reads PDFs & images with 98% accuracy",bg:"rgba(0,212,170,.12)"},
                {ico:"‚ö†Ô∏è",n:"Discrepancy Detection",d:"Flags overcharges, duplicates & surcharges",bg:"rgba(255,71,87,.12)"},
                {ico:"üßæ",n:"GST Verification",d:"Cross-checks every GST rate & HSN code",bg:"rgba(0,144,255,.12)"},
                {ico:"‚Çπ",n:"Cost Recovery",d:"Recover 5‚Äì10% of billing losses",bg:"rgba(255,211,42,.12)"},
                {ico:"‚ö°",n:"All Industries",d:"Logistics, petroleum, pharma, IT, finance...",bg:"rgba(108,143,255,.12)"},
                {ico:"üìã",n:"Detailed Reports",d:"Findings, root cause & legal references",bg:"rgba(0,212,170,.12)"},
              ].map(f =>
                <div key={f.n} className="feat">
                  <div className="feat-ico" style={{background:f.bg}}>{f.ico}</div>
                  <div><div className="feat-n">{f.n}</div><div className="feat-d">{f.d}</div></div>
                </div>
              )}
            </div>
            <div className="stats-row fu3">
              {[{n:"98%",l:"Accuracy",c:"#00d4aa"},{n:"5-10%",l:"Avg Savings",c:"#ff4757"},{n:"<30s",l:"Per Invoice",c:"#6c8fff"}].map(s =>
                <div key={s.l}><div className="stat-n" style={{color:s.c}}>{s.n}</div><div className="stat-l">{s.l}</div></div>
              )}
            </div>
          </div>

          <div className="fu2">
            <div className="up-panel">
              {/* CONTRACT UPLOAD */}
              <div style={{fontSize:11,fontWeight:700,color:"var(--tm)",textTransform:"uppercase",letterSpacing:".08em",marginBottom:8}}>
                Step 1 ‚Äî Upload Contract <span style={{color:"var(--tm)",fontWeight:400}}>(optional but recommended)</span>
              </div>
              <div
                className={`up-zone${contractDrag?" drag":""}${contract64?" rdy":""}`}
                style={{padding:"18px 20px",marginBottom:10}}
                onDragOver={e=>{e.preventDefault();setContractDrag(true);}}
                onDragLeave={()=>setContractDrag(false)}
                onDrop={e=>{e.preventDefault();setContractDrag(false);readContract(e.dataTransfer.files[0]);}}
                onClick={()=>contractRef.current?.click()}
              >
                <div style={{fontSize:28,marginBottom:6}}>{contract64?"üìã":"üìÑ"}</div>
                <div style={{fontSize:13,fontWeight:700,color:contract64?"var(--acc)":"var(--txt)",marginBottom:3}}>
                  {contractName||"Drop contract / agreement here"}
                </div>
                <div style={{fontSize:12,color:"var(--tm)"}}>
                  {contract64?`${contractName} ‚Äî contract loaded`:"PDF, PNG, JPG, JPEG, WEBP, TIFF"}
                </div>
                <input ref={contractRef} type="file" accept=".pdf,.png,.jpg,.jpeg,.webp,.tiff,.bmp" style={{display:"none"}}
                  onChange={e=>{if(e.target.files[0])readContract(e.target.files[0]);e.target.value="";}}/>
              </div>

              {/* INVOICE UPLOAD */}
              <div style={{fontSize:11,fontWeight:700,color:"var(--tm)",textTransform:"uppercase",letterSpacing:".08em",marginBottom:8}}>
                Step 2 ‚Äî Upload Invoice <span style={{color:"var(--red)",fontWeight:700}}>*</span>
              </div>
              <div
                className={`up-zone${drag?" drag":""}${file64?" rdy":""}`}
                style={{padding:"18px 20px",marginBottom:10}}
                onDragOver={e=>{e.preventDefault();setDrag(true);}}
                onDragLeave={()=>setDrag(false)}
                onDrop={e=>{e.preventDefault();setDrag(false);readFile(e.dataTransfer.files[0]);}}
                onClick={()=>fileRef.current?.click()}
              >
                <div style={{fontSize:28,marginBottom:6}}>{file64?"‚úÖ":"‚òÅÔ∏è"}</div>
                <div style={{fontSize:13,fontWeight:700,color:file64?"var(--acc)":"var(--txt)",marginBottom:3}}>
                  {fileName||"Drop invoice here or click to upload"}
                </div>
                <div style={{fontSize:12,color:"var(--tm)"}}>
                  {file64?`${fileName} ‚Äî ready for audit`:"PDF, PNG, JPG, JPEG, WEBP, TIFF ‚Äî any vendor format"}
                </div>
                <input ref={fileRef} type="file" accept=".pdf,.png,.jpg,.jpeg,.webp,.tiff,.bmp" style={{display:"none"}}
                  onChange={e=>{if(e.target.files[0])readFile(e.target.files[0]);e.target.value="";}}/>
              </div>

              {contract64 && <div style={{fontSize:12,color:"var(--acc)",marginBottom:8,display:"flex",alignItems:"center",gap:6}}>
                <span>üìã</span> Contract loaded ‚Äî AI will compare invoice against contract terms
              </div>}

              {file64 && (
                <button className="btn btn-acc btn-lg" style={{width:"100%",justifyContent:"center",marginTop:4}} onClick={runUpload}>
                  {contract64?"‚ñ∂ Audit Invoice vs Contract ‚Üí":"‚ñ∂ Run AI Audit ‚Üí"}
                </button>
              )}

              {err && (
                <div style={{marginTop:10,padding:"12px 14px",background:"var(--rdim)",borderRadius:9,border:"1px solid rgba(255,71,87,.2)",color:"var(--red)",fontSize:13,lineHeight:1.7,whiteSpace:"pre-wrap"}}>
                  {err}
                </div>
              )}

              <div className="demo-lbl">Demo 1 ‚Äî Invoice Only</div>
              {[DEMO_FTL, DEMO_BSC].map(demo =>
                <div key={demo.id} className="demo-card">
                  <div className="demo-top">
                    <div>
                      <div className="demo-n">{demo.vendor}</div>
                      <div className="demo-s">{demo.invoice} ¬∑ {demo.date}</div>
                    </div>
                    <div className="demo-btns">
                      <button className="btn btn-ghost btn-sm" onClick={()=>downloadDemoPDF(demo)}>‚¨á Invoice PDF</button>
                      <button className="btn btn-acc btn-sm" onClick={()=>runDemo(demo)}>‚ñ∂ Audit</button>
                    </div>
                  </div>
                  <div style={{background:"var(--s3)",borderRadius:7,padding:"8px 11px",fontSize:12,color:"var(--tm)",borderLeft:"2px solid var(--bd2)"}}>
                    üí° {demo.hint}
                  </div>
                </div>
              )}

              <div className="demo-lbl" style={{marginTop:16}}>Demo 2 ‚Äî Contract + Invoice (Full Audit)</div>
              <div className="demo-card" style={{borderColor:"rgba(0,212,170,.25)"}}>
                <div className="demo-top">
                  <div>
                    <div className="demo-n">TechServe Solutions ‚Äî IT Services</div>
                    <div className="demo-s">Contract TSS/MST/2024/047 + Invoice TSS-INV-2024-0312</div>
                  </div>
                  <div className="demo-btns">
                    <button className="btn btn-ghost btn-sm" onClick={()=>downloadContractPDF(DEMO_IT_CONTRACT)}>‚¨á Contract</button>
                    <button className="btn btn-ghost btn-sm" onClick={()=>downloadDemoPDF(DEMO_IT_INVOICE)}>‚¨á Invoice</button>
                    <button className="btn btn-acc btn-sm" onClick={()=>runDemoWithContract(DEMO_IT_INVOICE, DEMO_IT_CONTRACT)}>‚ñ∂ Full Audit</button>
                  </div>
                </div>
                <div style={{background:"var(--adim)",borderRadius:7,padding:"8px 11px",fontSize:12,color:"var(--acc)",borderLeft:"2px solid var(--bd2)"}}>
                  ‚ú® AI compares invoice against contract ‚Äî finds rate deviations, wrong GST, out-of-scope charges
                </div>
              </div>

              <div className="info">
                <div className="info-t">üí° How it works</div>
                <div className="info-b">
                  1. <strong style={{color:"var(--txt)"}}>Upload contract</strong> (optional) ‚Äî any format<br/>
                  2. <strong style={{color:"var(--txt)"}}>Upload invoice</strong> ‚Äî PDF, JPG, PNG, WEBP...<br/>
                  3. AI extracts every line item, rate, GST%, HSN code<br/>
                  4. If contract uploaded: compares every line against agreed terms<br/>
                  5. Full audit: overcharges, GST errors, out-of-scope charges
                </div>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* ANALYZING */}
      {view==="analyzing" && <AnalysisScreen step={aStep} pct={aPct} name={aName}/>}

      {/* DASHBOARD */}
      {view==="dashboard" && !analyzing && (
        <div className="db">
          <div className="db-top">
            <div>
              <div style={{fontSize:24,fontWeight:800,letterSpacing:"-.02em"}}>Audit Dashboard</div>
              <div style={{fontSize:13,color:"var(--tm)",marginTop:3}}>
                {invoices.length} invoice{invoices.length!==1?"s":""} analysed ¬∑ {invoices.reduce((s,i)=>s+(i.flags?.length||0),0)} issues found
              </div>
            </div>
            <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
              <button className="btn btn-ghost btn-sm" onClick={goHome}>‚¨Ö Home</button>
              <button className="btn btn-acc btn-sm" onClick={goHome}>‚¨Ü Upload Another</button>
            </div>
          </div>

          {invoices.length>0 && <>
            <div className="tabs">
              {tabList.map(t =>
                <button key={t.k} className={`tab${tab===t.k?" act":""}`} onClick={()=>setTab(t.k)}>{t.l}</button>
              )}
            </div>
            {tab==="dashboard" && <DashTab invoices={invoices}/>}
            {tab==="invoices" && <InvoicesTab invoices={invoices} onSelect={setSelInv}/>}
            {tab==="transactions" && <TxTab invoices={invoices}/>}
            {tab==="findings" && <FindingsTab invoices={invoices}/>}
          </>}

          {invoices.length===0 && (
            <div style={{textAlign:"center",padding:"60px 20px"}}>
              <div style={{fontSize:52,marginBottom:14}}>üìÇ</div>
              <div style={{fontSize:20,fontWeight:700,marginBottom:8}}>No invoices yet</div>
              <button className="btn btn-acc" onClick={goHome}>‚Üê Go Back</button>
            </div>
          )}
        </div>
      )}
    </div>
  );
}

ReactDOM.render(React.createElement(App), document.getElementById("root"));
</script>
</body>
</html>

